{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2>{{ 'Editar Producto' if producto else 'Agregar Producto' }}</h2>

    <form method="POST" action="{{ url_for('admin.editar_producto', id=producto.id) if producto else url_for('admin.agregar_producto') }}">
        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre del producto</label>
            <input type="text" class="form-control" id="nombre" name="nombre" value="{{ producto.nombre if producto else '' }}" required>
        </div>

        <div class="mb-3">
            <label for="descripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="descripcion" name="descripcion">{{ producto.descripcion if producto else '' }}</textarea>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <label for="precio" class="form-label">Precio</label>
                <input type="number" step="0.01" min="0" class="form-control" id="precio" name="precio" value="{{ producto.precio if producto else '' }}" required>
            </div>
            <div class="col-md-4">
                <label for="stock" class="form-label">Stock</label>
                <input type="number" min="0" class="form-control" id="stock" name="stock" value="{{ producto.stock if producto and producto.stock is not none else 0 }}" required>
            </div>
            <div class="col-md-4">
                <label for="categoria" class="form-label">Categoría</label>
                <select class="form-control" id="categoria" name="categoria_id" required>
                    {% for categoria in categorias %}
                    <option value="{{ categoria.id }}" {% if producto and producto.categoria_id == categoria.id %}selected{% endif %}>{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="mb-3 mt-3">
            <label for="imagen_url" class="form-label">URL de la imagen</label>
            <input type="text" class="form-control" id="imagen_url" name="imagen_url" value="{{ producto.imagen_url if producto else '' }}">
            <div class="form-text">Puedes pegar una URL o subir una imagen usando el área de abajo.</div>
        </div>

        <div class="mb-3">
            <label class="form-label d-block">Subir imagen (Drag & Drop)</label>
            <div id="dropZone" class="border border-2 border-dashed rounded p-4 text-center bg-light">
                <p class="mb-2">Arrastra y suelta una imagen aquí, o haz clic para seleccionar</p>
                <input id="fileInput" type="file" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" class="form-control" style="max-width: 350px; margin: 0 auto;">
                <small class="text-muted d-block mt-2">Formatos permitidos: PNG, JPG, JPEG, GIF, WEBP</small>
            </div>
            <div class="mt-3 text-center">
                <img id="previewImg" src="{{ producto.imagen_url if producto and producto.imagen_url else '' }}" alt="" class="img-fluid rounded" style="max-height: 240px; {% if not (producto and producto.imagen_url) %}display:none;{% endif %}">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Guardar</button>
    </form>
</div>

<style>
.border-dashed { border-style: dashed !important; }
#dropZone.dragover { background-color: #eef6ff; border-color: #0d6efd !important; }
</style>

<script>
(function () {
  const drop = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const urlInput = document.getElementById('imagen_url');
  const preview = document.getElementById('previewImg');

  function setPreview(url) {
    if (!preview) return;
    if (url) {
      preview.src = url;
      preview.style.display = 'inline-block';
    } else {
      preview.src = '';
      preview.style.display = 'none';
    }
  }

  async function uploadFile(file) {
    if (!file) return;
    const form = new FormData();
    form.append('file', file);
    try {
      const res = await fetch('{{ url_for("admin.upload_image") }}', { method: 'POST', body: form, credentials: 'same-origin' });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        alert((data && data.mensaje) || 'No se pudo subir la imagen');
        return;
      }
      urlInput.value = data.url;
      setPreview(data.url);
    } catch (e) {
      alert('Error de red al subir la imagen');
    }
  }

  if (drop && fileInput) {
    drop.addEventListener('click', () => fileInput.click());

    drop.addEventListener('dragover', (e) => {
      e.preventDefault();
      drop.classList.add('dragover');
    });

    drop.addEventListener('dragleave', (e) => {
      e.preventDefault();
      drop.classList.remove('dragover');
    });

    drop.addEventListener('drop', (e) => {
      e.preventDefault();
      drop.classList.remove('dragover');
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      uploadFile(file);
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      uploadFile(file);
    });
  }
})();
</script>
{% endblock %}
